"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const config_1 = require("../../../../config");
const request_1 = require("../../../../request");
const commands_1 = require("../../commands");
const Command_1 = require("../../../../Command");
const SpoCommand_1 = require("../../../base/SpoCommand");
const Utils_1 = require("../../../../Utils");
const vorpal = require('../../../../vorpal-init');
class SpoSiteSetCommand extends SpoCommand_1.default {
    get name() {
        return commands_1.default.SITE_SET;
    }
    get description() {
        return 'Updates properties of the specified site';
    }
    getTelemetryProperties(args) {
        const telemetryProps = super.getTelemetryProperties(args);
        telemetryProps.id = typeof args.options.id === 'string';
        telemetryProps.classification = typeof args.options.classification === 'string';
        telemetryProps.disableFlows = typeof args.options.disableFlows === 'string';
        return telemetryProps;
    }
    commandAction(cmd, args, cb) {
        let siteId = '';
        (() => {
            if (this.debug) {
                cmd.log(`Retrieving site ID...`);
            }
            if (args.options.id) {
                return Promise.resolve({ Id: args.options.id });
            }
            else {
                const requestOptions = {
                    url: `${args.options.url}/_api/site?$select=Id`,
                    headers: {
                        accept: 'application/json;odata=nometadata'
                    },
                    json: true
                };
                return request_1.default.get(requestOptions);
            }
        })()
            .then((res) => {
            siteId = res.Id;
            if (this.verbose) {
                cmd.log(`Retrieving request digest...`);
            }
            return this.getRequestDigest(args.options.url);
        })
            .then((res) => {
            if (this.verbose) {
                cmd.log(`Updating site ${args.options.url} properties...`);
            }
            const classification = typeof args.options.classification === 'string' ? `<SetProperty Id="27" ObjectPathId="5" Name="Classification"><Parameter Type="String">${Utils_1.default.escapeXml(args.options.classification)}</Parameter></SetProperty>` : '';
            const disableFlows = typeof args.options.disableFlows === 'string' ? `<SetProperty Id="28" ObjectPathId="5" Name="DisableFlows"><Parameter Type="Boolean">${args.options.disableFlows === 'true'}</Parameter></SetProperty>` : '';
            const requestOptions = {
                url: `${args.options.url}/_vti_bin/client.svc/ProcessQuery`,
                headers: {
                    'X-RequestDigest': res.FormDigestValue
                },
                body: `<Request AddExpandoFieldTypeSuffix="true" SchemaVersion="15.0.0.0" LibraryVersion="16.0.0.0" ApplicationName="${config_1.default.applicationName}" xmlns="http://schemas.microsoft.com/sharepoint/clientquery/2009"><Actions>${classification}${disableFlows}</Actions><ObjectPaths><Identity Id="5" Name="e10a459e-60c8-4000-8240-a68d6a12d39e|740c6a0b-85e2-48a0-a494-e0f1759d4aa7:site:${siteId}" /></ObjectPaths></Request>`
            };
            return request_1.default.post(requestOptions);
        })
            .then((res) => {
            const json = JSON.parse(res);
            const response = json[0];
            if (response.ErrorInfo) {
                cb(new Command_1.CommandError(response.ErrorInfo.ErrorMessage));
                return;
            }
            else {
                if (this.verbose) {
                    cmd.log(vorpal.chalk.green('DONE'));
                }
            }
            cb();
        }, (err) => this.handleRejectedPromise(err, cmd, cb));
    }
    options() {
        const options = [
            {
                option: '-u, --url <url>',
                description: 'The URL of the site collection to update'
            },
            {
                option: '-i, --id [id]',
                description: 'The ID of the site collection to update'
            },
            {
                option: '--classification [classification]',
                description: 'The new classification for the site collection'
            },
            {
                option: '--disableFlows [disableFlows]',
                description: 'Set to true to disable using Microsoft Flow in this site collection'
            }
        ];
        const parentOptions = super.options();
        return options.concat(parentOptions);
    }
    validate() {
        return (args) => {
            if (!args.options.url) {
                return 'Required parameter url missing';
            }
            const isValidSharePointUrl = SpoCommand_1.default.isValidSharePointUrl(args.options.url);
            if (isValidSharePointUrl !== true) {
                return isValidSharePointUrl;
            }
            if (args.options.id &&
                !Utils_1.default.isValidGuid(args.options.id)) {
                return `${args.options.id} is not a valid GUID`;
            }
            if (typeof args.options.classification === 'undefined' &&
                typeof args.options.disableFlows === 'undefined') {
                return 'Specify at least one property to update';
            }
            if (typeof args.options.disableFlows === 'string' &&
                args.options.disableFlows !== 'true' &&
                args.options.disableFlows !== 'false') {
                return `${args.options.disableFlows} is not a valid value for the disableFlow option. Allowed values are true|false`;
            }
            return true;
        };
    }
    types() {
        // required to support passing empty strings as valid values
        return {
            string: ['classification']
        };
    }
    commandHelp(args, log) {
        const chalk = vorpal.chalk;
        log(vorpal.find(commands_1.default.SITE_SET).helpInformation());
        log(`  Remarks:

    If the specified ${chalk.grey('url')} doesn't refer to an existing site collection,
    you will get a ${chalk.grey('404 - "404 FILE NOT FOUND"')} error.

    To update site collection's properties, the command requires site collection
    ID. The command can retrieve it automatically, but if you already have it,
    you can save an additional request, by specifying it using the ${chalk.grey('id')}
    option.

  Examples:
  
    Update site collection's classification. Will automatically retrieve the ID
    of the site collection
      ${this.name} --url https://contoso.sharepoint.com/sites/sales --classification MBI

    Reset site collection's classification.
      ${this.name} --url https://contoso.sharepoint.com/sites/sales --id 255a50b2-527f-4413-8485-57f4c17a24d1 --classification

    Disable using Microsoft Flow on the site collection. Will automatically retrieve the
    ID of the site collection
      ${this.name} --url https://contoso.sharepoint.com/sites/sales --disableFlows true
`);
    }
}
module.exports = new SpoSiteSetCommand();
//# sourceMappingURL=site-set.js.map